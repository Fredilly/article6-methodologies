# RC-20251217-151121 - Out-of-scope churn during scoped ingest

- **Title:** Out-of-scope churn during scoped ingest
- **Date:** 2025-12-17
- **Owners:** ingestion-ops
- **Linked invariant / plan section:** Phase 9 â€“ Sector Ingest Contract & Repo-wide Idempotency

## Summary
- Running `npm run ingest:full -- ingest.agriculture.yml` from a scoped branch rewrote Forestry artefacts (`methodologies/UNFCCC/Forestry/AR-ACM0003/v02-0/META.json` source hash) plus `registry.json`.
- CI failed on `git diff --exit-code`, blocking the Agriculture ingest PR even though Forestry was not in scope.

## Root Cause
- We lacked a guardrail tying the declared ingest scope to the actual diff. Forestry files shared helpers with Agriculture, so the generalized ingest re-hashed Forestry when agriculture inputs changed.
- No script checked that scoped ingest runs avoided out-of-scope churn, so stray Forestry updates reached git diff before anyone noticed.

## Fix
- Added `scripts/check-scope-drift.mjs` to parse ingest configs, derive scope roots, and fail if unrelated paths change (with an allowlist for intentional artefacts like `registry.json`).
- Wrapped the ingest pipeline in `scripts/ingest-scoped.sh` plus `npm run ingest:scoped(:idempotent)` to double-run scoped ingest, enforce git cleanliness, and run the drift check twice.
- Wired the scoped idempotency command into `stage-gates` so CI blocks any scoped ingest that touches out-of-scope files.

## Follow-up / Tests
- Ensure every scoped ingest PR runs `npm run ingest:scoped:idempotent -- <ingest.yml>` locally before review.
- Watch the new CI gate for early warning when shared generators accidentally touch other sectors; extend the allowlist only with explicit approval.
