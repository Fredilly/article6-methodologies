# RC-20251222-035340 â€” CI gates failed: root-cause index drift check required rg
- Date: 2025-12-22
- Area: ci
Tags: [ci, portability, guardrails]

## Symptom
CI runs `npm run validate:lean` (e.g. `.github/workflows/validate-json.yml`), which includes `bash scripts/check-root-cause-index-path.sh` (see `package.json`).

At commit `e0ca447`, `scripts/check-root-cause-index-path.sh` invoked `rg` unconditionally and fails on environments without ripgrep:

```
scripts/check-root-cause-index-path.sh: line 7: rg: command not found
scripts/check-root-cause-index-path.sh: line 21: rg: command not found
```

## Impact
Validate-json/validate-lean CI gates fail on runners/environments without `rg`, blocking changes that require the `validate:lean` workflow.

## Root cause
`e0ca447` introduced `scripts/check-root-cause-index-path.sh` and used ripgrep (`rg`) directly for both:
- repo-wide stale-path search
- generator output-path validation

This created an implicit tooling dependency for CI gate scripts.

## Fix
The check was made portable by removing the unconditional `rg` dependency and using fallbacks:
- `bd14fb1` added a portable fallback when `rg` is missing
- `ff050fc` further reduced reliance on `rg` by preferring `git grep` when available
- `196f085` simplified the check to use `git grep`/`grep` and `grep -Fq` without `rg`

## New invariants / guardrails
- CI guard scripts must not require non-POSIX tools unless explicitly installed in the runner/container; prefer `git grep`/`grep` with fixed-string matching for portability.

## Proof / tests
- Repro of the original failure (no `rg`, historical script):
  - `tmpdir="$(mktemp -d)" && git worktree add "$tmpdir" e0ca447 --detach && (cd "$tmpdir" && env PATH=/usr/bin:/bin bash scripts/check-root-cause-index-path.sh)`
  - Output includes `rg: command not found` (see Symptom).
- Proof of fix (no `rg`, current script): `env PATH=/usr/bin:/bin bash scripts/check-root-cause-index-path.sh` prints `[root-cause:index-path] ok`.

## Follow-ups
- [ ] Audit other CI-facing scripts for `rg` usage (e.g. `scripts/ingest-sanity.sh`) and either install it in the runner/container or add portable fallbacks.
