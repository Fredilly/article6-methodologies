name: Ingest (Reusable)

on:
  workflow_dispatch:
    inputs:
      scope:
        description: "Concurrency scope label"
        default: "manual"
      source:
        description: "Ingest source"
        default: "ingest"
      mode:
        description: "Mode"
        default: "both"
      dry_run:
        description: "Run without writing files"
        default: "false"
      batch_file:
        description: "Path to .txt file with methodology codes"
        required: false
      issue_number:
        description: "Issue number when source=issue"
      project_number:
        description: "Project number when source=project"
  repository_dispatch:
    types: [ingest-button]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20.11.1'
  TMP_DIR: ./.tmp
  SCOPED: ./.tmp/ingest.scoped.yml

jobs:
  ingest:
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/ingest'))
    runs-on: ubuntu-latest
    concurrency:
      group: ingest-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          clean: true
          fetch-depth: 0
          lfs: true

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - uses: actions/setup-go@4d34df0c2316fe8122ab82dc22947d607c0c91f9
        with:
          go-version: '1.22.1'

      - name: Install pup
        run: |
          set -euxo pipefail
          go install github.com/ericchiang/pup@v0.4.0
          sudo install -m 0755 "$(go env GOPATH)/bin/pup" /usr/local/bin/pup
          pup --version

      - name: Install
        run: |
          npm ci || npm i

      - name: Install ingest tools
        run: bash scripts/setup/install-ingest-tools.sh

      - name: Determine scope & mode
        id: meta
        run: |
          set -euo pipefail
          EVENT="${{ github.event_name }}"
          mode="both"
          source="ingest"
          issue=""
          project=""
          dry_run="false"
          batch=""
          if [ "$EVENT" = "workflow_dispatch" ]; then
            mode=$(jq -r '.inputs.mode // "both"' "$GITHUB_EVENT_PATH")
            source=$(jq -r '.inputs.source // "ingest"' "$GITHUB_EVENT_PATH")
            issue=$(jq -r '.inputs.issue_number // ""' "$GITHUB_EVENT_PATH")
            project=$(jq -r '.inputs.project_number // ""' "$GITHUB_EVENT_PATH")
            dry_run=$(jq -r '.inputs.dry_run // "false"' "$GITHUB_EVENT_PATH")
            batch=$(jq -r '.inputs.batch_file // ""' "$GITHUB_EVENT_PATH")
          elif [ "$EVENT" = "repository_dispatch" ]; then
            mode=$(jq -r '.client_payload.mode // "both"' "$GITHUB_EVENT_PATH")
            source=$(jq -r '.client_payload.source // "ingest"' "$GITHUB_EVENT_PATH")
            issue=$(jq -r '.client_payload.issue_number // ""' "$GITHUB_EVENT_PATH")
            project=$(jq -r '.client_payload.project_number // ""' "$GITHUB_EVENT_PATH")
            dry_run=$(jq -r '.client_payload.dry_run // "false"' "$GITHUB_EVENT_PATH")
            batch=$(jq -r '.client_payload.batch_file // ""' "$GITHUB_EVENT_PATH")
          elif [ "$EVENT" = "issue_comment" ]; then
            body=$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")
            if [[ "$body" =~ ^/ingest([[:space:]]+([[:alpha:]]+))? ]]; then
              if [ -n "${BASH_REMATCH[2]:-}" ]; then
                mode="${BASH_REMATCH[2]}"
              fi
            else
              echo "comment missing /ingest command" >&2
              exit 1
            fi
            issue=$(jq -r '.issue.number // ""' "$GITHUB_EVENT_PATH")
            project=""
            source="issue"
            dry_run="false"
            batch=""
          fi
          if [ -z "$mode" ] || [ "$mode" = "null" ]; then mode="both"; fi
          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "source=$source" >> "$GITHUB_OUTPUT"
          echo "issue=$issue" >> "$GITHUB_OUTPUT"
          echo "project=$project" >> "$GITHUB_OUTPUT"
          echo "dry_run=$dry_run" >> "$GITHUB_OUTPUT"
          echo "batch=$batch" >> "$GITHUB_OUTPUT"

      - name: Resolve scope → .tmp/ingest.scoped.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p "$TMP_DIR"
          SRC="${{ steps.meta.outputs.source }}"
          ISSUE_NO="${{ steps.meta.outputs.issue }}"
          PROJ_NO="${{ steps.meta.outputs.project }}"
          FILE_INPUT="${{ steps.meta.outputs.batch }}"
          if [ -n "$FILE_INPUT" ]; then
            node scripts/resolve-ingest-scope.mjs \
              --source "txt" \
              --in "$FILE_INPUT" \
              --out "$SCOPED"
          else
            node scripts/resolve-ingest-scope.mjs \
              --source "${SRC:-ingest}" \
              --issue "${ISSUE_NO:-0}" \
              --project "${PROJ_NO:-0}" \
              --in ingest.yml \
              --out "$SCOPED"
          fi

      - name: Run ingest (rich/lean)
        id: ingest
        env:
          MODE: ${{ steps.meta.outputs.mode }}
        run: |
          set -euo pipefail
          export PATH="$PWD/local-tools/bin:$PATH"
          echo "MODE=$MODE"
          run_rich=1
          run_lean=1
          case "$MODE" in
            batch|both)
              run_rich=1
              run_lean=1
              ;;
            single|rich)
              run_rich=1
              run_lean=0
              ;;
            lean)
              run_rich=0
              run_lean=1
              ;;
            *)
              echo "[warn] MODE '$MODE' not recognized → defaulting to both"
              run_rich=1
              run_lean=1
              ;;
          esac
          if [ -x scripts/ingest.sh ]; then
            export INGEST_FILE="$SCOPED"
            if [ "$run_rich" -eq 1 ]; then
              scripts/ingest.sh
            fi
            if ( [ "$run_rich" -eq 0 ] || [ "$run_lean" -eq 1 ] ) && [ -x scripts/derive-lean.sh ]; then
              scripts/derive-lean.sh
            fi
          else
            if [ "$run_rich" -eq 1 ]; then npm run ingest:rich --if-present -- "$SCOPED"; fi
            if [ "$run_lean" -eq 1 ]; then npm run ingest:lean --if-present -- "$SCOPED"; fi
          fi

      - name: Refresh META hashes
        run: ./scripts/hash-all.sh

      - name: Validate & quality gates
        run: |
          set -e
          npm run validate:rich --if-present
          npm run validate:lean --if-present
          npm run validate --if-present || true

      - name: Detect changes
        id: diff
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit & PR
        if: steps.diff.outputs.changed == 'true' && steps.meta.outputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          BR="chore/ingest-button-${{ github.run_id }}"
          git switch -c "$BR"
          git config user.name "article6-bot"
          git config user.email "bot@article6.org"
          RUN_ID="${{ github.run_id }}"
          cat <<'MSG' > /tmp/commit_msg.txt
          Ingest: run ${RUN_ID} (rich→lean)

          WHAT
          - Scoped ingest via resolver (issue/project/ingest.yml)
          - Ran rich and lean, validated, staged artefacts

          WHY
          - One-click, idempotent ingest tied to Issues/Projects for auditability

          Signed-off-by: fredilly@article6.org
          MSG
          git commit -F /tmp/commit_msg.txt
          git push -u origin "$BR"
          git fetch --depth=1 origin main
          if gh pr create --fill --title "Ingest: ${BR}"; then
            gh pr edit --add-label ingest || true
          else
            echo "[warn] gh pr create failed; skipping automatic PR labelling"
          fi

      - name: Upload logs (artifact)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ingest-logs
          path: ${{ env.TMP_DIR }}
